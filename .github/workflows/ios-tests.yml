name: iOS Tests

on:
  workflow_dispatch:
    inputs:
      tags:
        description: 'Enter Cucumber tag to run'
        required: true
        default: "@UAT"
        type: string

jobs:
  build-ios:
    runs-on: macos-14 
    env:
      TAGS: ${{ github.event.inputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'
      - run: |
           xcodebuild -version
           gem install cocoapods

      - name: Setup Appium
        run: |
          npm install -g appium@next
          appium -v
          appium driver install xcuitest
          # Timeouts Appium
          echo '{
            "appium:adbExecTimeout": 120000,
            "appium:uiautomator2ServerInstallTimeout": 120000,
            "appium:uiautomator2ServerLaunchTimeout": 120000,
            "appium:appInstallTimeout": 120000}' > default-capabilities.json
          nohup appium --port 4723 --log-level info --default-capabilities "$(cat default-capabilities.json)" > appium.log 2>&1 &
          sleep 5
          appium driver list --installed

      - name: Run iOS Simulator and Tests
        run: |
          xcrun simctl list devices
          xcrun simctl boot "iPhone 14"
          xcrun simctl status_bar "iPhone 14" override --batteryState charged --batteryLevel 100
          echo "Simulator booted!"
          cat appium.log | tail -n 50
          mvn clean test \
            -Dspring.config.location=src/test/resources/application.yaml \
            -Duat.currentEnv=ios \
            -Dcucumber.filter.tags="${TAGS}"

      - name: Upload Appium Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-logs-ios
          path: appium.log
